# Задание 1. Анализ, идентификация проблем и решений, планирование

## Дополнение

При анализе системы не удалось понять, кто такой Seller и как он взаимодействует с клиентами. Для дальнейшего разбора системы закреплю следующее определение:

**Seller** - человек, использующий CRM SPA приложение для валидации/подтверждения заказа.


## Существующие проблемы

| Описание | Тип рефакторинга | Возможное решение |
|----------|------------------|-------------------|
| Клиент не получил заказ | Функциональный/Инфраструктурный | Необходимо внедрение дополнительных мониторингов для анализа логов/трейсинга и детектирования проблемы. Проблема может иметь функциональный характер, сл-но, мониторинги помогут детектировать проблему. С т.з. инфраструктуры пока не получается предположить, где могла бы быть проблема (падения приложения не были описаны в текущих проблемах). Возможно, доходим до ограничения в максимальном кол-ве сообщений в топике RabbitMQ. Как следствие, сообщение может быть утеряно и клиент не получит свой заказ |
| Долгая работа над изделием | Инфраструктурный | Нагрузка на MES слишком высокая. Из-за этого происходит задержка в обработке стоимости изделий, а так же, возможно, есть ещё и падения данного приложения. К тому же, очередь в RabbitMQ может забиваться из-за большой нагрузки на MES. Как следствие, по FIFO имеем очень долгое ожидания обработки заказа, даже если оно может быть выполнено и есть свободные операторы |
| Долгая работа над изделием | Инфраструктурный | Так как MES выполняет роль приложения, которое рассчитывает стоимость выполнения изделия, то, сл-во, работа MES приложения может нагружать полностью систему, а так же его API. Как следствие, мы можем отвалиться по таймауту к API MES. Таким образом, если у нас реализован повтор интеграции от внешней системы, мы имеем проблему долгой работы над извелием. Если же повтора интеграции нет или после всех повторов у нас не реализована обработка ошибки интеграции, то мы можем полностью потерять запрос от внешней системы. Необходимо переходить на очередь |
| Нагрузка на MES | Функциональный и инфраструктурный | Основная проблема, необходимо масштабироваться и рефачить то, что в одном приложении совместили работу операторов и основной (коробочный) функционал MES |
| Совмещённая логика MES "рассчёт стоимости" и "api" | Функциональный | Необходимо разделить логику работы приложения MES. Судя по тому, что компания купила софт MES, который выполняет расчёт стоимости изделия, api для работы операторов сделали надстройкой над этим приложением |
| Один инстанс приложения MES для расчёта стоимости | Инфраструктурный | Необходимо масштабироваться на большее кол-во инстансов, т.к это самое узкое место во всей системе |
| Нагрузка на MES API | Функциональный и инфраструктурный | Увеличилось кол-во потребителей у MES API. Так как API User не ожидает ответа от MES судя по текущей архитектуре, имеем постоянные get интеграции на MES API для проверки выполнения расчёта стоимости изделия из внешних систем. Решение описано выше + можно добавить redis, но нужны метрики (опционально и не в первой итерации) |
| Проблема с MES SPA | Функциональный | Проблема связана с нагрузкой на MES API. Также необходим анализ spa приложения, чтобы определить, что, как и когда (lazy loading) загружается |
| Нагрузка на MES со стороны MES SPA | Функциональный | Некоторую логику можно заменить на более гибкую и легковесную |
| Нет load balancer | Инфраструктурный | Отсутствие балансировщика не было проблемой с 1 инстансом, но после масштабирования - станет |
| CRM API и Shop API имеют одну общую бд | Инфраструктурный и функциональный | Необходимо либо разделить бд на две и сделать взаимодействие через API, либо оставить всё as is, но CRM API <-> Shop DB переключить через Shop api, а не напрямую |
| Высокая Latency для удалённых от сервера пользователей | Инфраструктурный | Необходимо реализовать геораспределённую архитектуру |
| Добавление кэширования, CDN | Инфраструктурный и функциональный | Снятие дополнительной нагрузки. Добавление CDN для Internet shop, анализ перед добавлением redis на необходимость такого шага |
| CI/CD | Инфраструктурный | Реализация решения на основе jenkins для автоматической сборки поставки и установки на последующие среды. Jenkins - задел на будущее, т.к. сейчас, скорее всего, используется github actions или что-то подобное |
| Внедрение k8s + helm | Инфраструктурный | Внедрение кубера для более гибкой управляемости. Решение позволит нам быстрее поставлять новый функционал, автоматически развёртывать его, легко масштабироваться, управлять обнаружением новых сервисов, иметь мониторинг контейнеров и быстро восстанавливаться при сбоях |
| Тестирование | Функциональный | Необходима автоматизация тестирования. Ручное тестирование системы занимает крайне много времени. Покрытие функционала автотестами даст возможность быстро детектировать и устранять проблемы в приложениях |
| Метрики | Функциональный и инфраструктурный | Как уже упоминалось ранее, необходима внедрение метрик для детектирования и анализа проблем |
| БД | Инфраструктурный | Пока нет никакой информации о том, что происходит с нагрузкой на бд. При подключении метрик можно посмотреть, что происходит с бд и, если есть проблемы, добавить шарды в зависимости от проблемы |
| БД отказоустойчивость | Инфраструктурный | Необходимо добавить реплики для бд для повышения отказоустойчивости |
| Несколько потребителей подключения к s3 хранилищу | Функциональный | Проблема в том, что мы не можем чётко контролировать нагрузку с разных приложений. К тому же мы имеем зависимости двух приложений от одного инстанса. Необходимо сделать развязвку от подключения двух приложений к одному хранилищу |

Данные проблемы не являются финальными. При взаимодействии с заказчиком можно уточнить, что необходим так же доп. анализ систем, на предмет дополнительных доработок.

Для устранения необходимо нанять:
- Толкового QA с опытом автоматического тестирования
- DevOps инженера с опытом работы с микросервисной архитектурой (настройка k8s, helm, load balancer, jenkins)
- Если есть возможность, берём так же C# разработчика для ускорения работы с MES (опционально, т.к., возможно, онбординг нового разработчика будет только мешать. В таком случае, можно выполнить рефакторинг, а уже потом взять разраба на минорные доработки)

## Приоритизация

**Команда разработки:**
1. Работа над доработкой системы (если нельзя отложить)
2. Переход всех приложений на работу через очередь
3. Разделение MES на две части: коробка и api
4. Рефакторинг проблемы "CRM API и Shop API имеют одну общую бд"
5. s3 рефакторинг одного хранилища для нескольких приложений
6. Рефакторинг "Нагрузка на MES со стороны MES SPA". Операторам не нужно видеть список. Достаточно иметь механизм, позволяющий брать в работу приоритетную задачу на основе скиллов оператора (снижаем нагрузку и убираем потенциальные конфликты между заказами и операторами)

**DevOps:**
1. Развёртывание и настройка load balancer
2. Развёртывание и настройка k8s, helm
3. Масштабирование MES (или MES + MES API, если команда разработки к этому времени выполнит рефакторинг)
4. Внедрение ELK, prometheus, grafana
5. Внедрение улучшенного CI/CD пайплайна, внедрение автотестов на заглушках при сборке поставки

**QA:**
1. Продолжает работать над тестированием поставок
2. Работа над автоматизацией тестирования. Автоматизацию можно начать с приложения, где чаще всего появляются баги

**Лид:**
1. Анализ метрик по приложениям, работа над задачами с непонятными причинами (клиент не получил заказ). Скорее всего у нас к этому времени ещё не будет готов observability, но предполагаем, что лид сможет понять, где существует проблема для её исправления. Нам важно закрыть данную проблему, т.к. она негативно влияет на кол-во наших клиентов
2. БД отказоустойчивость, добавляем репликацию
3. Реализация геораспределённой архитектуры (доп пункт, если есть необходимость)

## Заключение

Целевая архитектура должна решить все перечисленные выше проблемы. Однако, если говорить на горизонте пол года и только три пункта, то нужно обязательно сделать:
1. Переход на взаимодействие через очередь
2. Ввод k8s и load balancer
3. Масштабировать MES и MES API, т.к. на данный момент MES - это узкая точка данной системы
4. Разделение MES
5. Введение метрик. Крайне важный пункт, но выполняется не в самом высоком приоритете, т.к. мы уже сейчас понимаем основные проблемы текущей архитектуры

Целевая архитектура приложена в виде draw.io файла