# Задание 2. Мониторинг

## 2.2 Анализ

На данный момент в системе нет никаких вспомогательных инструментов для сбора метрик и анализа работы компонентов. Это приводит к тому, что при срочных доработках системы, мы не знаем ничего о нагрузке, ошибках, отказоустойчивости и т.д. В системе присутствуют несколько приложений, которые не взаимодействуют друг с другом напрямую: Shop Api -> S3 -> MES API (тут предполагаю, что MES API забирает каждые n минут/секунд новые записи из S3 для подсчёта стоимости работ); Shop API -> Shop DB <- CRM API. В такой парадигме сложно проследить флоу заказа и проанализировать проблемные места. Рефакторинг позволит развязать данные проблемы, но лишь частично. К тому же, с учётом приоритизации некоторые моменты будут исправлены не в первую очередь. Таким образом, мы не знаем, где может "выстрелить" следующая проблема. 

## 2.3 Мотивация

Предполагаем, что мы верно выбрали самый узкий кусок всей системы. Тогда из этого следует, что все силы будут брошены на рефакторинг/доработку данного компонента. Однако, исходя из того, что на текущий момент нет никаких метрик и данных о работе каждого из компонентов, мы не можем с уверенностью сказать, что доработка MES даст необходимый результат. К тому же, на данный момент мы не знаем ничего о том, насколько загружены бд.
Так же присутствуют неопределённости с функциональными проблемами (заказ не был отправлен). Подобные проблемы могут быть легко проанализированы, если бы у нас был бы сквозной трейсинг. Однако сейчас из-за его отсутствия, нам необходимо потратить немало времени на анализ проблемы, которая может в целом оказаться инфраструктурной. Для этого обязательно необходимо вводить сквозной трейсинг.
Мы так же не знаем ничего о работе наших API. Они могут откидывать ошибки по таймауту, могут парсить неправильно данные или внешние системы могут присылать неправильный контракт. Из-за отсутствия логов и инструментов для анализа, мы не можем понять, где существует проблема и, следовательно, как её решать.
Мы так же не знаем, хватает ли нам ресурсов на наших компонентах. При нехватке ресурсов, приложения могут крашиться, могут долго отвечать. Чтобы полечить это, сперва необходимо понять, где именно у нас возникает данная проблема и какие ресурсы на каких компонентах необходимо добавить, либо как и что нам нужно масштабировать.
Внедрение мониторинга обеспечит нам чёткое понимание узких мест всей системы. На анализ проблем не будут уходить десятки часов. Каждая проблема будет чётко детектироваться за короткий промежуток времени.
Так же мониторинги позволят нам быстрее реагировать на аварийные ситуации. Так как на данный момент у нас есть пулл задач, которые нам необходимо выполнить и мы не можем дорабатывать всё и сразу, то и подобный алёртинг поможет нам, в случае чего, быстрее реагировать на проблемные места.

## 2.4 Выбор подхода к мониторингу

Я придерживаюсь того, что 4 золотых сигнала дают нам достаточно информации о наших компонентах в функциональном ключе. К данному подходу можно добавить USE метод для того, чтобы видеть нагрузку с т.з. "железа" на наших компонентах

## 2.5 Метрики

| Название                                           | Цель                                                                                                                                                                   | Ярлыки                                                                                |
|----------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------|
| Dead-letter-exchange                               | сбор данных о том, не накапливаются ли у нас сообщения в dead letter queue. Может свидетельствовать о неправильных контрактах или, скажем, проблемах с инфраструктурой | Ярлыки могут отображать название очередей для MQ                                      |
| Number of message in flight in RabbitMQ            | Покажет, справляется ли та или иная система с нагрузкой в моменте                                                                                                      | Как и выше - название очередей MQ                                                     |
| RPS                                                | Количество реквестов в секунду. Полезно для анализа нагрузки на API                                                                                                    | Метрика по системам, ярлыки по service package, по конкретным сервисам, по ноде (env) |
| CPU %                                              | Процент утилизации CPU                                                                                                                                                 | Метрика по системам, ярлыки по контейнерам (нодам)                                    |
| Memory Utilisation                                 | Утилизация озу                                                                                                                                                         | Метрика по системам, Ярлыки по контейнерам (нодам)                                    |
| Number of connections for shop db instance         | Кол-во подключений к бд                                                                                                                                                | Метрики по системам, ярлыки по разным нодам, которые создают подключение              |
| Latency                                            | Время выполнения запросов                                                                                                                                              | Метрики по системам, ярлыки по service package, по конкретным сервисам, по нодам      |
| Size db                                            | Занятое дисковое пространство для бд                                                                                                                                   | Без ярлыков, по каждой системе будет своя метрика                                     |
| Количество 2xx, 3xx, 4xx, 5xx                      | Кол-во запросов по различным кодам (это отдельные метрики, но не стал выделять их в разные строки | Ярлыки: нода, service pachage, конкретный сервис                                      |
| First Contentful Paint, Largest Contentful Paint, Time To Interactive | Метрики (в разные строки должны быть), которые показывают нам то, как работает SPA приложение | Тип девайса, тип браузера, геопозиция, операционная система                           |


## 2.6 План действий

### Развертывание инфраструктуры
1. Поднять Prometheus в Docker-контейнере для сбора метрик
2. Настроить Prometheus на сбор данных с микросервисов, RabbitMQ и API Gateway
3. Развернуть Grafana в Docker для визуализации метрик и логов
4. Установить Elasticsearch и Logstash
5. Настроить Kibana для анализа и поиска логов

### Интегрирование
1. Настроить Spring Boot Actuator с Prometheus для мониторинга бизнес-метрик
2. Настроить сбор логов приложений в ELK через Filebeat или Logback. 

### Визуализация и дашборды
1. Создать Grafana-дашборды для отображения метрик
2. Настроить Kibana-дашборды для анализа логов

### Настройка алертинга
1. Определить критические метрики для алертов
2. Настроить Alertmanager для обработки и группировки алертов из Prometheus
3. Интегрировать алерты с Slack/Email/PagerDuty для уведомлений
4. Настроить пороги срабатывания